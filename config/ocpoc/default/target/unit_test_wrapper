#!/bin/sh
HOST_PATH=$1
FULL_COMMAND=${*:2}
TARGET_DIR="/home/root/unit-test"
TARGET_GCOV_PREFIX="${TARGET_DIR}/output"
TARGET_USER="root"
TARGET_ADDRESS="zedboard.windhoverlabs.lan"

ssh ${TARGET_USER}@${TARGET_ADDRESS} "mkdir -p ${TARGET_DIR}"
ssh ${TARGET_USER}@${TARGET_ADDRESS} "mkdir -p ${TARGET_GCOV_PREFIX}"
scp -r ${HOST_PATH} ${TARGET_USER}@${TARGET_ADDRESS}:${TARGET_DIR}
ssh ${TARGET_USER}@${TARGET_ADDRESS} "cd ${TARGET_DIR}; GCOV_PREFIX=${TARGET_GCOV_PREFIX} GCOV_PREFIX_STRIP=0 ${FULL_COMMAND}"
RETURN_CODE=$?
scp -r ${TARGET_USER}@${TARGET_ADDRESS}:${TARGET_DIR}/*.xml ${HOST_PATH}/output
scp -r ${TARGET_USER}@${TARGET_ADDRESS}:${TARGET_DIR}/output/* ${HOST_PATH}/output
ssh ${TARGET_USER}@${TARGET_ADDRESS} "rm -Rf ${TARGET_DIR}"

exit ${RETURN_CODE}
