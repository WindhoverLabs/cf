extends ../../common/layout

block header
        i.fa-fw.fa.fa-signal
        | PX4 - Distance Sensor

block main
    .row.row-fluid
      article.col-xs-10.col-sm-6.col-md-6.col-lg-6
        #wid-SM.jarviswidget.jarviswidget-color-blueDark(data-widget-editbutton='false')
          header(style="overflow:hidden;")
            span.widget-icon
              i.fa.fa-table
            h2 Sensor - Distance
          div
            .jarviswidget-editbox
              input.form-control(type='text')
            .widget-body
              #Distance(style='width:100%; height:300px;')

      article.col-xs-10.col-sm-6.col-md-6.col-lg-6(style='max-width:450px')
        #wid-SA.jarviswidget.jarviswidget-color-blueDark(data-widget-editbutton='false')
          header(style="overflow:hidden;")
            span.widget-icon
              i.fa.fa-table
            h2 Sensor - Distance
          div
            .jarviswidget-editbox
              input.form-control(type='text')
            .widget-body
              .table-responsive
                table.table.table-condensed
                  tbody
                    tr
                      th Minimum:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_MinDistance"}]}) ---
                    tr
                      th Maximum:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_MaxDistance"}]}) ---
                    tr
                      th Current:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_CurrentDistance"}]}) ---
                    tr
                      th Covariance:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_Covariance"}]}) ---
                    tr
                      th Type:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_Type"}]}) ---
                    tr
                      th ID:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_ID"}]}) ---
                    tr
                      th Orientation:
                      td 
                        span(data-sage={tlm: [{name: "/CFS/PX4/DS_Orientation"}]}) ---


      script.
        var MaxCount = 2500;
        var Data = [];
        
        $(function () {
          function legendFormatter(label, series) {
            return '<div ' + 
               'style="color:white;font-size:8pt;text-align:left;padding:4px;padding-left:10px">' +
               label + '</div>';
          };
    
          var UtilGraph = $.plot($("#Distance"), [],{
              xaxis : {
                mode : 'time',
                font : {
                  color: "#ffffff"
                }
              },
              yaxis : {
                min : 0.0,
                max : 50.0,
                font : {
                  color: "#ffffff"
                }
              },
              series : {
                lines : {
                  show : true
                },
                points: {
                  show: false
                }
              },
              legend: {
                show: true,
                labelFormatter: legendFormatter,
                labelBoxBorderColor: 'rgba(255, 255, 255, 0.0)',
                noColumns: 1,
                position: 'ne',
                margin: [10,10],
                backgroundColor: null,
                backgroundOpacity: 0,
                container: null,
                sorted: false
              },
              grid: {
                show: true,
                //aboveData: boolean
                //color: '#ffffff',
                //backgroundColor: color/gradient or null
                //margin: number or margin object
                //labelMargin: number
                //axisMargin: number
                //markings: [{ color: "#ffffff" }],
                //markings: array of markings or (fn: axes -> array of markings)
                //borderWidth: number or object with "top", "right", "bottom" and "left" properties with different widths
                //borderColor: color or null or object with "top", "right", "bottom" and "left" properties with different colors
                //minBorderMargin: number or null
                //clickable: boolean
                //hoverable: boolean
                //autoHighlight: boolean
                //mouseActiveRadius: number
              }
            }
          );
        

              var MaxCount = 120;
              var ignoreCount = 3;
              var updateInterval = 100;
              var count = 0;
              var prev = -1;
      
              session.subscribe({
                tlm: [
                  {name: '/CFS/PX4/DS_CurrentDistance'}
                ]},function(params) {                
                  count = count + 1;
                  if(ignoreCount > 0){
                    ignoreCount = ignoreCount - 1;
                  } else { 
                    if (Data.length >= MaxCount) {
                      Data = Data.slice(1);
                    }
        
                    var timeStamp = new Date(params[0].acquisitionTime);
                    var D = params[0].engValue.floatValue;
                     
                    Data.push([timeStamp, D]);
                  }
              });

              function update() {
                UtilGraph.setData(
                  [{
                    data: Data,
                    label: "meters",
                    color: '#ff00ff'
                  }]);
        
        
                // since the axes don't change, we don't need to call plot.setupGrid()
                UtilGraph.setupGrid();
                UtilGraph.draw();
                setTimeout(update, updateInterval);
              }
                  
              update();
            });



